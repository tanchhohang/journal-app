@page "/journal"
@using journalApp.Models
@using journalApp.Services
@using journalApp.Components.Journal
@inject IEntryService EntryService
@inject IStreakService StreakService
@inject IJSRuntime JS

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <PageHeader />
        </div>
        <div class="streak-display">
            <div class="text-center">
                <h3 class="mb-0">@currentStreak</h3>
                <small class="text-muted">day streak</small>
            </div>
            <div class="text-center ms-4">
                <h3 class="mb-0">@longestStreak</h3>
                <small class="text-muted">best streak</small>
            </div>
        </div>
    </div>

    <SearchBar SearchText="@searchText"
               SearchTextChanged="HandleSearchTextChanged"
               AvailableTags="@allTags"
               OnFilterApplied="HandleFilterApplied" />

    <div class="mb-4">
        @if (hasEntryToday)
        {
            <div class="alert alert-info">
                <i class="bi bi-check-circle"></i> you've already logged your journal for today! you can edit it from the cards below.
            </div>
        }
        else
        {
            <button class="btn btn-dark btn-lg w-100" @onclick="OpenNewEntryForm">
                <i class="bi bi-plus-circle"></i> log today's journal
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">loading...</span>
            </div>
        </div>
    }
    else if (!filteredEntries.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-journal-x" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">no journal entries found.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var entry in filteredEntries)
            {
                <JournalCard Entry="@entry" 
                           OnEdit="HandleEditEntry"
                           OnDelete="HandleDeleteEntry" />
            }
        </div>
    }

    <EntryFormModal ShowForm="@showForm"
                   IsNewEntry="@isNewEntry"
                   CurrentEntry="@currentEntry"
                   TagsText="@tagsText"
                   OnTagsTextChanged="HandleTagsTextChanged"
                   OnSave="HandleSaveEntry"
                   OnClose="CloseForm" />
</div>

<style>
    .streak-display {
        display: flex;
        gap: 2rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
    }

    .streak-display h3 {
        font-weight: bold;
        font-size: 2rem;
    }
</style>

@code {
    private List<Entry> allEntries = new();
    private List<Entry> filteredEntries = new();
    private List<string> allTags = new();
    private bool isLoading = true;
    private bool showForm = false;
    private bool isNewEntry = true;
    private bool hasEntryToday = false;
    private Entry currentEntry = new();
    private string tagsText = "";
    private string searchText = "";
    private int currentStreak = 0;
    private int longestStreak = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        allEntries = await EntryService.GetAllEntriesAsync();
        filteredEntries = allEntries;
        allTags = await EntryService.GetAllTagsAsync();
        hasEntryToday = await EntryService.HasEntryForDateAsync(DateTime.Today);
        currentStreak = await StreakService.GetCurrentStreak();
        longestStreak = await StreakService.GetLongestStreak();
        isLoading = false;
        StateHasChanged();
    }

    private void OpenNewEntryForm()
    {
        if (hasEntryToday) return;

        currentEntry = new Entry 
        { 
            Date = DateTime.Today,
            Title = "",
            Content = "",
            Mood = "Happy"
        };
        tagsText = "";
        isNewEntry = true;
        showForm = true;
    }

    private void HandleEditEntry(Entry entry)
    {
        currentEntry = new Entry
        {
            Id = entry.Id,
            Date = entry.Date,
            Title = entry.Title,
            Content = entry.Content,
            Mood = entry.Mood,
            Tags = new List<string>(entry.Tags)
        };
        tagsText = string.Join(", ", entry.Tags);
        isNewEntry = false;
        showForm = true;
    }

    private async Task HandleSaveEntry()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(tagsText))
            {
                currentEntry.Tags = tagsText.Split(',')
                    .Select(t => t.Trim())
                    .Where(t => !string.IsNullOrEmpty(t))
                    .ToList();
            }

            if (isNewEntry)
            {
                if (await EntryService.HasEntryForDateAsync(currentEntry.Date))
                {
                    await JS.InvokeVoidAsync("alert", "you already have an entry for this date!");
                    return;
                }
                await EntryService.AddEntryAsync(currentEntry);
            }
            else
            {
                await EntryService.UpdateEntryAsync(currentEntry);
            }

            await LoadData();
            CloseForm();
        }
        catch (InvalidOperationException ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "error saving entry: " + ex.Message);
        }
    }

    private async Task HandleDeleteEntry(Entry entry)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            $"are you sure you want to delete '{entry.Title}'?");
        
        if (confirmed)
        {
            await EntryService.DeleteEntryAsync(entry.Id);
            await LoadData();
        }
    }

    private void CloseForm()
    {
        showForm = false;
        currentEntry = new Entry();
        tagsText = "";
    }

    private async Task HandleSearchTextChanged(string newSearchText)
    {
        searchText = newSearchText;
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredEntries = allEntries;
        }
        else
        {
            filteredEntries = await EntryService.SearchEntriesAsync(searchText);
        }
        StateHasChanged();
    }

    private void HandleTagsTextChanged(string newTagsText)
    {
        tagsText = newTagsText;
    }

    private async Task HandleFilterApplied(SearchBar.FilterCriteria criteria)
    {
        var serviceCriteria = new FilterCriteria
        {
            SearchText = criteria.SearchText,
            MoodCategory = criteria.MoodCategory,
            SpecificMood = criteria.SpecificMood,
            Tag = criteria.Tag,
            FromDate = criteria.FromDate,
            ToDate = criteria.ToDate
        };

        filteredEntries = await EntryService.FilterEntriesAsync(serviceCriteria);
        StateHasChanged();
    }
}
