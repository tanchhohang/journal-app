@page "/"
@using journalApp.Models
@using journalApp.Services
@using journalApp.Components.Journal
@using journalApp.Components.Layout
@inject IEntryService EntryService
@inject IStreakService StreakService
@inject IJSRuntime JS

<div class="main-content">
    <PageHeader @ref="pageHeaderRef" />

    <hr style="border-color: #8B898C;" />

    <SearchBar SearchText="@searchText" 
               SearchTextChanged="HandleSearchChanged"
               AvailableTags="@allTags"
               OnFilterApplied="HandleFilterApplied" />

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border"></div>
        </div>
    }
    else
    {
        <div class="row g-4">
            <AddJournalCard OnClick="ShowNewEntryForm" />

            @foreach (var entry in PaginatedEntries)
            {
                <JournalCard Entry="@entry" OnEdit="EditEntry" OnDelete="DeleteEntry" />
            }
        </div>

        <div class="d-flex justify-content-center align-items-center gap-3 mt-4">
            <button class="btn btn-sm btn-outline-primary" @onclick="PrevPage" disabled="@(_currentPage == 1)">
                &lt; Prev
            </button>
            <span>Page @_currentPage of @_totalPages</span>
            <button class="btn btn-sm btn-outline-primary" @onclick="NextPage" disabled="@(_currentPage == _totalPages)">
                Next &gt;
            </button>
        </div>
    }
</div>

<EntryFormModal 
    ShowForm="@showForm"
    IsNewEntry="@isNewEntry"
    CurrentEntry="@currentEntry"
    TagsText="@tagsText"
    OnTagsTextChanged="(value) => tagsText = value"
    OnSave="SaveEntry"
    OnClose="CloseForm" />

@code {
    private List<Entry> entries = new();
    private List<Entry> filteredEntries = new();
    private List<string> allTags = new();
    private bool showForm = false;
    private Entry currentEntry = new();
    private bool isNewEntry = true;
    private string tagsText = "";
    private string searchText = "";
    private bool isLoading = true;
    private string dbPath = "";
    private PageHeader? pageHeaderRef;

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    private int _currentPage = 1;
    private int _pageSize = 5;
    private int _totalPages => (int)Math.Ceiling((double)filteredEntries.Count / _pageSize);

    private IEnumerable<Entry> PaginatedEntries => filteredEntries
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize);

    protected override async Task OnInitializedAsync()
    {
        dbPath = Path.Combine(FileSystem.AppDataDirectory, "journal.db3");
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            entries = await EntryService.GetAllEntriesAsync();
            filteredEntries = entries;
            allTags = await EntryService.GetAllTagsAsync();

            _currentPage = 1;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowNewEntryForm()
    {
        isNewEntry = true;
        currentEntry = new Entry 
        { 
            Date = DateTime.Today, 
            Mood = "Happy",
            Title = "",
            Content = "",
            Tags = new List<string>()
        };
        tagsText = "";
        showForm = true;
        StateHasChanged();
    }

    private void EditEntry(Entry entry)
    {
        isNewEntry = false;
        currentEntry = new Entry
        {
            Id = entry.Id,
            Title = entry.Title,
            Date = entry.Date,
            Mood = entry.Mood,
            Content = entry.Content,
            Tags = new List<string>(entry.Tags ?? new List<string>())
        };
        tagsText = string.Join(", ", entry.Tags ?? new List<string>());
        showForm = true;
        StateHasChanged();
    }

    private async Task SaveEntry()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(tagsText))
            {
                currentEntry.Tags = tagsText.Split(',')
                    .Select(t => t.Trim())
                    .Where(t => !string.IsNullOrWhiteSpace(t))
                    .ToList();
            }
            else
            {
                currentEntry.Tags = new List<string>();
            }

            if (isNewEntry)
            {
                await EntryService.AddEntryAsync(currentEntry);
            }
            else
            {
                await EntryService.UpdateEntryAsync(currentEntry);
            }

            await LoadData();

            await StreakService.UpdateStreak();
            if (pageHeaderRef != null)
            {
                await pageHeaderRef.RefreshStreak();
            }

            CloseForm();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task DeleteEntry(Entry entry)
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete '{entry.Title}'?");
            if (confirmed)
            {
                await EntryService.DeleteEntryAsync(entry.Id);
                await LoadData();
                await StreakService.UpdateStreak();
                if (pageHeaderRef != null)
                    await pageHeaderRef.RefreshStreak();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting: {ex.Message}");
        }
    }

    private void CloseForm()
    {
        showForm = false;
        StateHasChanged();
    }

    private async Task HandleSearchChanged(string newSearchText)
    {
        searchText = newSearchText;
        filteredEntries = string.IsNullOrWhiteSpace(searchText) 
            ? entries 
            : await EntryService.SearchEntriesAsync(searchText);

        _currentPage = 1;
        StateHasChanged();
    }

    private async Task HandleFilterApplied(SearchBar.FilterCriteria criteria)
    {
        var serviceCriteria = new FilterCriteria
        {
            SearchText = criteria.SearchText,
            MoodCategory = criteria.MoodCategory,
            SpecificMood = criteria.SpecificMood,
            Tag = criteria.Tag,
            FromDate = criteria.FromDate,
            ToDate = criteria.ToDate
        };

        filteredEntries = await EntryService.FilterEntriesAsync(serviceCriteria);
        _currentPage = 1;
        StateHasChanged();
    }

    private void NextPage()
    {
        if (_currentPage < _totalPages)
            _currentPage++;
    }

    private void PrevPage()
    {
        if (_currentPage > 1)
            _currentPage--;
    }
}