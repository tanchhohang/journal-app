@inherits LayoutComponentBase
@using journalApp.Services
@using journalApp.Components.Journal
@inject ISecurityService SecurityService
@inject IThemeService ThemeService
@inject IJSRuntime JS

@if (ShowSetup)
{
    <SetupSecurity OnSetupComplete="OnSetupComplete" />
}
else if (IsLocked)
{
    <LockScreen OnUnlocked="OnUnlocked" />
}
else
{
    <div class="app-layout">
        <NavMenu />

        <div class="page-wrapper">
            <div class="main-content-wrapper">
                <div class="top-bar">
                    <ThemeToggle />
                    <button class="btn btn-sm btn-outline-dark ms-2" @onclick="LockApp">
                        <i class="bi bi-lock"></i> Lock
                    </button>
                </div>

                @Body
            </div>
        </div>
    </div>

}

<style>
    .main-content-wrapper {
        padding: 1rem 2rem;
        min-height: 100vh;
    }

    .top-bar {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
</style>

@code {
    private bool IsLocked { get; set; } = false;
    private bool ShowSetup { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // check if security is set up
            var hasSetup = await SecurityService.HasSecuritySetup();
            if (!hasSetup)
            {
                // force security setup - no skip option
                ShowSetup = true;
            }
            else
            {
                // if security is set up, lock the app
                await SecurityService.LockApp();
                IsLocked = true;
            }

            // apply saved theme
            var theme = await ThemeService.GetTheme();
            await ApplyTheme(theme);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in MainLayout initialization: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await ThemeService.GetTheme();
            await ApplyTheme(theme);
        }
    }

    private async Task ApplyTheme(string theme)
    {
        try
        {            
            // use proper JavaScript interop to set the theme class
            await JS.InvokeVoidAsync("setTheme", theme);
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying theme: {ex.Message}");
        }
    }


    private async Task OnSetupComplete()
    {
        ShowSetup = false;
        IsLocked = false;
        StateHasChanged();
    }

    private async Task OnUnlocked()
    {
        IsLocked = false;
        StateHasChanged();
    }

    private async Task LockApp()
    {
        await SecurityService.LockApp();
        IsLocked = true;
        StateHasChanged();
    }
}