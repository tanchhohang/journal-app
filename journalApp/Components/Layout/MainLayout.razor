@inherits LayoutComponentBase
@using journalApp.Services
@using journalApp.Components.Journal
@inject ISecurityService SecurityService
@inject IThemeService ThemeService
@inject IJSRuntime JS

@if (ShowSetup)
{
    <SetupSecurity OnSetupComplete="OnSetupComplete" OnGoToLogin="GoToLogin" />
}
else if (IsLocked)
{
    <LockScreen OnUnlocked="OnUnlocked" OnGoToSignup="GoToSignup" />
}
else
{
    <CascadingValue Value="this">
        <div class="app-layout">
            <NavMenu />

            <div class="page-wrapper">
                <div class="main-content-wrapper">
                    <div class="top-bar">
                        <ThemeToggle />
                        <button class="btn btn-sm btn-outline-dark ms-2" @onclick="LockApp">
                            <i class="bi bi-lock"></i> Lock
                        </button>
                    </div>

                    @Body
                </div>
            </div>
        </div>
    </CascadingValue>
}

<style>
    .main-content-wrapper {
        padding: 1rem 2rem;
        min-height: 100vh;
    }

    .top-bar {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
</style>

@code {
    private bool IsLocked { get; set; } = false;
    private bool ShowSetup { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var hasSetup = await SecurityService.HasSecuritySetup();
            
            if (!hasSetup)
            {
                ShowSetup = true;
            }
            else
            {
                await SecurityService.LockApp();
                IsLocked = true;
            }

            var theme = await ThemeService.GetTheme();
            await ApplyTheme(theme);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in MainLayout initialization: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await ThemeService.GetTheme();
            await ApplyTheme(theme);
        }
    }

    private async Task ApplyTheme(string theme)
    {
        try
        {
            await JS.InvokeVoidAsync("setTheme", theme);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying theme: {ex.Message}");
        }
    }

    private async Task OnSetupComplete()
    {
        ShowSetup = false;
        IsLocked = false;
        StateHasChanged();
    }

    private async Task OnUnlocked()
    {
        IsLocked = false;
        StateHasChanged();
    }

    private async Task LockApp()
    {
        await SecurityService.LockApp();
        IsLocked = true;
        StateHasChanged();
    }

    public async Task HandleLogout()
    {
        await SecurityService.LogoutAsync();
        
        IsLocked = true;
        ShowSetup = false;
        StateHasChanged();
    }

    private void GoToLogin()
    {
        ShowSetup = false;
        IsLocked = true;
        StateHasChanged();
    }

    private void GoToSignup()
    {
        IsLocked = false;
        ShowSetup = true;
        StateHasChanged();
    }
}