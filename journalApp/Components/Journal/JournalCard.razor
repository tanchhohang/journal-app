@using journalApp.Models
@using journalApp.Services
@inject IPdfExportService PdfExportService

<div class="col-xl-4 col-lg-4 col-md-6">
    <div class="card journal-card h-100">
        <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1 me-3">
                    <h5 class="journal-title">@Entry.Title</h5>
                    <small class="journal-date">@Entry.Date.ToString("dd MMMM, yyyy")</small>
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                    <span class="@GetMoodBadgeClass(Entry.Mood)">
                        @GetMoodCategory(Entry.Mood)
                    </span>
                    <span class="secondary-mood-badge">@Entry.Mood</span>
                </div>
            </div>

            <div class="journal-body flex-grow-1 mb-3">
                @((MarkupString)GetPreview(Entry.Content))
            </div>

            @if (Entry.Tags != null && Entry.Tags.Any())
            {
                <div class="d-flex flex-wrap gap-2 mb-3">
                    @foreach (var tag in Entry.Tags)
                    {
                        <span class="tag-badge">@tag</span>
                    }
                </div>
            }

            <div class="d-flex justify-content-end gap-3 pt-3 border-top action-buttons">
                <button class="btn btn-sm btn-link text-decoration-none p-0" 
                        @onclick="() => OnEdit.InvokeAsync(Entry)">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-link text-decoration-none p-0"
                        @onclick="ExportToPdf"
                        disabled="@isExporting">
                    <i class="bi bi-file-earmark-pdf"></i> @(isExporting ? "Exporting..." : "Export")
                </button>
                <button class="btn btn-sm btn-link text-decoration-none p-0"
                        @onclick="() => OnDelete.InvokeAsync(Entry)">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Entry Entry { get; set; } = new Entry();

    [Parameter]
    public EventCallback<Entry> OnEdit { get; set; }

    [Parameter]
    public EventCallback<Entry> OnDelete { get; set; }

    private bool isExporting = false;

    private string GetMoodCategory(string mood)
    {
        var positive = new[] { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
        var neutral = new[] { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
        var negative = new[] { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

        if (positive.Contains(mood)) return "Positive";
        if (neutral.Contains(mood)) return "Neutral";
        if (negative.Contains(mood)) return "Negative";
        return "Neutral";
    }

    private string GetMoodBadgeClass(string mood)
    {
        var category = GetMoodCategory(mood);
        return category switch
        {
            "Positive" => "text-success", 
            "Negative" => "text-danger",  
            _ => "text-warning"             
        };
    }

    private string GetPreview(string htmlContent)
    {
        if (string.IsNullOrEmpty(htmlContent)) return "";

        // Strip HTML tags for preview
        var text = System.Text.RegularExpressions.Regex.Replace(htmlContent, "<.*?>", " ");
        text = System.Text.RegularExpressions.Regex.Replace(text, @"\s+", " ").Trim();
        
        // Truncate to 150 characters
        if (text.Length > 150)
        {
            text = text.Substring(0, 150) + "...";
        }

        return text;
    }

    private async Task ExportToPdf()
    {
        try
        {
            isExporting = true;
            StateHasChanged();

            var filePath = await PdfExportService.ExportJournalToPdfAsync(Entry);

            // Open the PDF file with the default application
            await OpenPdfFile(filePath);

            // Show success message (you can implement a toast notification here)
            Console.WriteLine($"PDF exported successfully: {filePath}");
        }
        catch (Exception ex)
        {
            // Show error message (you can implement a toast notification here)
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task OpenPdfFile(string filePath)
    {
        try
        {
#if MACCATALYST || IOS
            await Launcher.Default.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(filePath)
            });
#elif ANDROID
            var file = new Java.IO.File(filePath);
            var uri = AndroidX.Core.Content.FileProvider.GetUriForFile(
                Android.App.Application.Context,
                Android.App.Application.Context.PackageName + ".fileprovider",
                file);
            
            var intent = new Android.Content.Intent(Android.Content.Intent.ActionView);
            intent.SetDataAndType(uri, "application/pdf");
            intent.SetFlags(Android.Content.ActivityFlags.GrantReadUriPermission);
            Android.App.Application.Context.StartActivity(intent);
#elif WINDOWS
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = filePath,
                UseShellExecute = true
            };
            System.Diagnostics.Process.Start(psi);
#endif
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening PDF: {ex.Message}");
        }
    }
}